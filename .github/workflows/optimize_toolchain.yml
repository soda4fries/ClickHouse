# generated by praktika

name: OptimizeToolchain
on:
  workflow_dispatch:
    inputs:

env:
  PYTHONUNBUFFERED: 1
  CHECKOUT_REF: ""
# Allow updating GH commit statuses and PR comments to post an actual job reports link
permissions: write-all

jobs:

  config_workflow:
    runs-on: [self-hosted, style-checker-aarch64]
    needs: []
    name: "Config Workflow"
    outputs:
      data: ${{ steps.run.outputs.DATA }}
      pipeline_status: ${{ steps.run.outputs.pipeline_status || 'undefined' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          ref: ${{ env.CHECKOUT_REF }}

      - name: Prepare env script
        run: |
          rm -rf ./ci/tmp
          mkdir -p ./ci/tmp
          cat > ./ci/tmp/praktika_setup_env.sh << 'ENV_SETUP_SCRIPT_EOF'
          export PYTHONPATH=./ci:.:
          cat > ./ci/tmp/workflow_inputs.json << 'EOF'
          ${{ toJson(github.event.inputs) }}
          EOF
          cat > ./ci/tmp/workflow_job.json << 'EOF'
          ${{ toJson(job) }}
          EOF
          cat > ./ci/tmp/workflow_status.json << 'EOF'
          ${{ toJson(needs) }}
          EOF
          ENV_SETUP_SCRIPT_EOF

      - name: Run
        id: run
        run: |
          . ./ci/tmp/praktika_setup_env.sh
          set -o pipefail
          PYTHONUNBUFFERED=1 python3 -m praktika run 'Config Workflow' --workflow "OptimizeToolchain" --ci 2>&1 | python3 -u -c 'import sys,datetime
          prefix=lambda: datetime.datetime.now().strftime("[%Y-%m-%d %H:%M:%S]")
          for line in sys.stdin: sys.stdout.write(prefix() + " " + line); sys.stdout.flush()' | tee ./ci/tmp/job.log

  dockers_build_amd:
    runs-on: [self-hosted, style-checker]
    needs: [config_workflow]
    if: ${{ !cancelled() && !contains(needs.*.outputs.pipeline_status, 'failure') && !contains(needs.*.outputs.pipeline_status, 'undefined') && !contains(fromJson(needs.config_workflow.outputs.data).workflow_config.cache_success_base64, 'RG9ja2VycyBCdWlsZCAoYW1kKQ==') }}
    name: "Dockers Build (amd)"
    outputs:
      data: ${{ steps.run.outputs.DATA }}
      pipeline_status: ${{ steps.run.outputs.pipeline_status || 'undefined' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          ref: ${{ env.CHECKOUT_REF }}

      - name: Prepare env script
        run: |
          rm -rf ./ci/tmp
          mkdir -p ./ci/tmp
          cat > ./ci/tmp/praktika_setup_env.sh << 'ENV_SETUP_SCRIPT_EOF'
          export PYTHONPATH=./ci:.:
          cat > ./ci/tmp/workflow_inputs.json << 'EOF'
          ${{ toJson(github.event.inputs) }}
          EOF
          cat > ./ci/tmp/workflow_job.json << 'EOF'
          ${{ toJson(job) }}
          EOF
          cat > ./ci/tmp/workflow_status.json << 'EOF'
          ${{ toJson(needs) }}
          EOF
          ENV_SETUP_SCRIPT_EOF

      - name: Run
        id: run
        run: |
          . ./ci/tmp/praktika_setup_env.sh
          set -o pipefail
          PYTHONUNBUFFERED=1 python3 -m praktika run 'Dockers Build (amd)' --workflow "OptimizeToolchain" --ci 2>&1 | python3 -u -c 'import sys,datetime
          prefix=lambda: datetime.datetime.now().strftime("[%Y-%m-%d %H:%M:%S]")
          for line in sys.stdin: sys.stdout.write(prefix() + " " + line); sys.stdout.flush()' | tee ./ci/tmp/job.log

  dockers_build_arm:
    runs-on: [self-hosted, style-checker-aarch64]
    needs: [config_workflow]
    if: ${{ !cancelled() && !contains(needs.*.outputs.pipeline_status, 'failure') && !contains(needs.*.outputs.pipeline_status, 'undefined') && !contains(fromJson(needs.config_workflow.outputs.data).workflow_config.cache_success_base64, 'RG9ja2VycyBCdWlsZCAoYXJtKQ==') }}
    name: "Dockers Build (arm)"
    outputs:
      data: ${{ steps.run.outputs.DATA }}
      pipeline_status: ${{ steps.run.outputs.pipeline_status || 'undefined' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          ref: ${{ env.CHECKOUT_REF }}

      - name: Prepare env script
        run: |
          rm -rf ./ci/tmp
          mkdir -p ./ci/tmp
          cat > ./ci/tmp/praktika_setup_env.sh << 'ENV_SETUP_SCRIPT_EOF'
          export PYTHONPATH=./ci:.:
          cat > ./ci/tmp/workflow_inputs.json << 'EOF'
          ${{ toJson(github.event.inputs) }}
          EOF
          cat > ./ci/tmp/workflow_job.json << 'EOF'
          ${{ toJson(job) }}
          EOF
          cat > ./ci/tmp/workflow_status.json << 'EOF'
          ${{ toJson(needs) }}
          EOF
          ENV_SETUP_SCRIPT_EOF

      - name: Run
        id: run
        run: |
          . ./ci/tmp/praktika_setup_env.sh
          set -o pipefail
          PYTHONUNBUFFERED=1 python3 -m praktika run 'Dockers Build (arm)' --workflow "OptimizeToolchain" --ci 2>&1 | python3 -u -c 'import sys,datetime
          prefix=lambda: datetime.datetime.now().strftime("[%Y-%m-%d %H:%M:%S]")
          for line in sys.stdin: sys.stdout.write(prefix() + " " + line); sys.stdout.flush()' | tee ./ci/tmp/job.log

  build_toolchain_pgo_bolt_amd64:
    runs-on: [self-hosted, amd-large]
    needs: [config_workflow, dockers_build_amd, dockers_build_arm]
    if: ${{ !cancelled() && !contains(needs.*.outputs.pipeline_status, 'failure') && !contains(needs.*.outputs.pipeline_status, 'undefined') && !contains(fromJson(needs.config_workflow.outputs.data).workflow_config.cache_success_base64, 'QnVpbGQgVG9vbGNoYWluIChQR08sIEJPTFQpIChhbWQ2NCk=') }}
    name: "Build Toolchain (PGO, BOLT) (amd64)"
    outputs:
      data: ${{ steps.run.outputs.DATA }}
      pipeline_status: ${{ steps.run.outputs.pipeline_status || 'undefined' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          ref: ${{ env.CHECKOUT_REF }}

      - name: Prepare env script
        run: |
          rm -rf ./ci/tmp
          mkdir -p ./ci/tmp
          cat > ./ci/tmp/praktika_setup_env.sh << 'ENV_SETUP_SCRIPT_EOF'
          export PYTHONPATH=./ci:.:
          cat > ./ci/tmp/workflow_inputs.json << 'EOF'
          ${{ toJson(github.event.inputs) }}
          EOF
          cat > ./ci/tmp/workflow_job.json << 'EOF'
          ${{ toJson(job) }}
          EOF
          cat > ./ci/tmp/workflow_status.json << 'EOF'
          ${{ toJson(needs) }}
          EOF
          ENV_SETUP_SCRIPT_EOF

      - name: Run
        id: run
        run: |
          . ./ci/tmp/praktika_setup_env.sh
          set -o pipefail
          PYTHONUNBUFFERED=1 python3 -m praktika run 'Build Toolchain (PGO, BOLT) (amd64)' --workflow "OptimizeToolchain" --ci 2>&1 | python3 -u -c 'import sys,datetime
          prefix=lambda: datetime.datetime.now().strftime("[%Y-%m-%d %H:%M:%S]")
          for line in sys.stdin: sys.stdout.write(prefix() + " " + line); sys.stdout.flush()' | tee ./ci/tmp/job.log

  build_toolchain_pgo_bolt_aarch64:
    runs-on: [self-hosted, arm-large]
    needs: [config_workflow, dockers_build_amd, dockers_build_arm]
    if: ${{ !cancelled() && !contains(needs.*.outputs.pipeline_status, 'failure') && !contains(needs.*.outputs.pipeline_status, 'undefined') && !contains(fromJson(needs.config_workflow.outputs.data).workflow_config.cache_success_base64, 'QnVpbGQgVG9vbGNoYWluIChQR08sIEJPTFQpIChhYXJjaDY0KQ==') }}
    name: "Build Toolchain (PGO, BOLT) (aarch64)"
    outputs:
      data: ${{ steps.run.outputs.DATA }}
      pipeline_status: ${{ steps.run.outputs.pipeline_status || 'undefined' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          ref: ${{ env.CHECKOUT_REF }}

      - name: Prepare env script
        run: |
          rm -rf ./ci/tmp
          mkdir -p ./ci/tmp
          cat > ./ci/tmp/praktika_setup_env.sh << 'ENV_SETUP_SCRIPT_EOF'
          export PYTHONPATH=./ci:.:
          cat > ./ci/tmp/workflow_inputs.json << 'EOF'
          ${{ toJson(github.event.inputs) }}
          EOF
          cat > ./ci/tmp/workflow_job.json << 'EOF'
          ${{ toJson(job) }}
          EOF
          cat > ./ci/tmp/workflow_status.json << 'EOF'
          ${{ toJson(needs) }}
          EOF
          ENV_SETUP_SCRIPT_EOF

      - name: Run
        id: run
        run: |
          . ./ci/tmp/praktika_setup_env.sh
          set -o pipefail
          PYTHONUNBUFFERED=1 python3 -m praktika run 'Build Toolchain (PGO, BOLT) (aarch64)' --workflow "OptimizeToolchain" --ci 2>&1 | python3 -u -c 'import sys,datetime
          prefix=lambda: datetime.datetime.now().strftime("[%Y-%m-%d %H:%M:%S]")
          for line in sys.stdin: sys.stdout.write(prefix() + " " + line); sys.stdout.flush()' | tee ./ci/tmp/job.log

  update_toolchain_dockerfile:
    runs-on: [self-hosted, style-checker]
    needs: [config_workflow, dockers_build_amd, dockers_build_arm, build_toolchain_pgo_bolt_amd64, build_toolchain_pgo_bolt_aarch64]
    if: ${{ !cancelled() && !contains(needs.*.outputs.pipeline_status, 'failure') && !contains(needs.*.outputs.pipeline_status, 'undefined') && !contains(fromJson(needs.config_workflow.outputs.data).workflow_config.cache_success_base64, 'VXBkYXRlIFRvb2xjaGFpbiBEb2NrZXJmaWxl') }}
    name: "Update Toolchain Dockerfile"
    outputs:
      data: ${{ steps.run.outputs.DATA }}
      pipeline_status: ${{ steps.run.outputs.pipeline_status || 'undefined' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          ref: ${{ env.CHECKOUT_REF }}

      - name: Prepare env script
        run: |
          rm -rf ./ci/tmp
          mkdir -p ./ci/tmp
          cat > ./ci/tmp/praktika_setup_env.sh << 'ENV_SETUP_SCRIPT_EOF'
          export PYTHONPATH=./ci:.:
          cat > ./ci/tmp/workflow_inputs.json << 'EOF'
          ${{ toJson(github.event.inputs) }}
          EOF
          cat > ./ci/tmp/workflow_job.json << 'EOF'
          ${{ toJson(job) }}
          EOF
          cat > ./ci/tmp/workflow_status.json << 'EOF'
          ${{ toJson(needs) }}
          EOF
          ENV_SETUP_SCRIPT_EOF

      - name: Run
        id: run
        run: |
          . ./ci/tmp/praktika_setup_env.sh
          set -o pipefail
          PYTHONUNBUFFERED=1 python3 -m praktika run 'Update Toolchain Dockerfile' --workflow "OptimizeToolchain" --ci 2>&1 | python3 -u -c 'import sys,datetime
          prefix=lambda: datetime.datetime.now().strftime("[%Y-%m-%d %H:%M:%S]")
          for line in sys.stdin: sys.stdout.write(prefix() + " " + line); sys.stdout.flush()' | tee ./ci/tmp/job.log

  finish_workflow:
    runs-on: [self-hosted, style-checker-aarch64]
    needs: [config_workflow, dockers_build_amd, dockers_build_arm, build_toolchain_pgo_bolt_amd64, build_toolchain_pgo_bolt_aarch64, update_toolchain_dockerfile]
    if: ${{ always() }}
    name: "Finish Workflow"
    outputs:
      data: ${{ steps.run.outputs.DATA }}
      pipeline_status: ${{ steps.run.outputs.pipeline_status || 'undefined' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          ref: ${{ env.CHECKOUT_REF }}

      - name: Prepare env script
        run: |
          rm -rf ./ci/tmp
          mkdir -p ./ci/tmp
          cat > ./ci/tmp/praktika_setup_env.sh << 'ENV_SETUP_SCRIPT_EOF'
          export PYTHONPATH=./ci:.:
          cat > ./ci/tmp/workflow_inputs.json << 'EOF'
          ${{ toJson(github.event.inputs) }}
          EOF
          cat > ./ci/tmp/workflow_job.json << 'EOF'
          ${{ toJson(job) }}
          EOF
          cat > ./ci/tmp/workflow_status.json << 'EOF'
          ${{ toJson(needs) }}
          EOF
          ENV_SETUP_SCRIPT_EOF

      - name: Run
        id: run
        run: |
          . ./ci/tmp/praktika_setup_env.sh
          set -o pipefail
          PYTHONUNBUFFERED=1 python3 -m praktika run 'Finish Workflow' --workflow "OptimizeToolchain" --ci 2>&1 | python3 -u -c 'import sys,datetime
          prefix=lambda: datetime.datetime.now().strftime("[%Y-%m-%d %H:%M:%S]")
          for line in sys.stdin: sys.stdout.write(prefix() + " " + line); sys.stdout.flush()' | tee ./ci/tmp/job.log
